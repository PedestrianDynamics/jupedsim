#! /usr/bin/env python3

import math
import sys
from pathlib import Path

import jupedsim as jps
import py_jupedsim as pjps
import py_jupedsim.experimental as jpex
import shapely
import vtkmodules.vtkRenderingOpenGL2
from PyQt6 import QtWidgets
from PyQt6.QtCore import Qt
from vtkmodules.qt.QVTKRenderWindowInteractor import QVTKRenderWindowInteractor
from vtkmodules.vtkInteractionStyle import vtkInteractorStyleUser
from vtkmodules.vtkRenderingCore import (
    vtkRenderer,
)
from visdbg.config import Colors, ZLayers
from visdbg.move_controller import MoveController
from visdbg.grid import Grid
from visdbg.geometry import Geometry, HoverInfo


def build_jps_geometry(geo: shapely.GeometryCollection):
    geo_builder = pjps.GeometryBuilder()

    for obj in geo.geoms:
        if obj.geom_type != "Polygon":
            raise Exception(
                "Unexpected geometry type found in GeometryCollection: {obj.type}"
            )
        geo_builder.add_accessible_area(obj.exterior.coords[:-1])
        for hole in obj.interiors:
            geo_builder.exclude_from_accssible_area(hole.coords[:-1])
    return geo_builder.build()


class MainWindow(QtWidgets.QMainWindow):
    def __init__(self, parent=None):
        QtWidgets.QMainWindow.__init__(self, parent)
        self.navi = None
        self.geo = None
        self.geo_bounds = None
        self.setWindowTitle("VisTwo")
        self.__build_menu_bar()
        self.setCentralWidget(QtWidgets.QWidget())
        layout = QtWidgets.QVBoxLayout()
        self.centralWidget().setLayout(layout)

        self.actor = None
        self.edge_actor = None

        self.geometry_label = QtWidgets.QLabel("Geometry: nothing loaded")
        self.geometry_label.setAlignment(Qt.AlignmentFlag.AlignLeft)

        self.properties_label = QtWidgets.QLabel("")
        self.properties_label.setAlignment(Qt.AlignmentFlag.AlignRight)

        bottom_layout = QtWidgets.QHBoxLayout()
        bottom_layout.addWidget(
            self.geometry_label, 1, Qt.AlignmentFlag.AlignLeft
        )
        bottom_layout.addWidget(
            self.properties_label, 1, Qt.AlignmentFlag.AlignRight
        )

        reset_cam_bt = QtWidgets.QPushButton("Reset Camera")
        reset_cam_bt.clicked.connect(self.__reset_camera)

        layout.addWidget(reset_cam_bt)

        self.vtk_widget = QVTKRenderWindowInteractor()
        layout.addWidget(self.vtk_widget)
        self.hover_label = QtWidgets.QLabel("")
        self.hover_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        layout.addWidget(self.hover_label)
        layout.addLayout(bottom_layout)

        self.ren = vtkRenderer()
        self.ren.SetBackground(Colors.d)
        self.vtk_widget.GetRenderWindow().AddRenderer(self.ren)
        self.iren = self.vtk_widget.GetRenderWindow().GetInteractor()

        cam = self.ren.GetActiveCamera()
        cam.ParallelProjectionOn()

        self.__reset_camera()

        self.showMaximized()
        style = vtkInteractorStyleUser()
        self.iren.SetInteractorStyle(style)
        self.iren.Initialize()

        self.move_controller = MoveController(style, cam)
        self.hover_info = HoverInfo(self.ren, style)
        self.hover_info.hoveredTriangle.connect(self.hover_label.setText)

        self.grid = Grid(self.ren, cam)

    def __build_menu_bar(self):
        menu = self.menuBar()
        open_menu = menu.addMenu("Open")
        open_wkt_act = open_menu.addAction("WKT")
        open_wkt_act.triggered.connect(self.__on_load_wkt)

    def __reset_camera(self):
        focal_pt_2d = (0, 0)
        scale = 10
        if self.geo:
            bounds = self.geo.get_bounds()
            width = bounds[1] - bounds[0]
            height = bounds[3] - bounds[2]
            focal_pt_2d = (bounds[0] + width / 2, bounds[2] + height / 2)

            (
                viewport_aspect_width,
                viewport_aspect_height,
            ) = self.ren.GetAspect()
            viewport_aspect_ratio = (
                viewport_aspect_width / viewport_aspect_height
            )
            scene_aspect_ratio = width / height

            if viewport_aspect_ratio > scene_aspect_ratio:
                scale = (height / 2) * 1.05
            else:
                scale = (width / 2) / viewport_aspect_ratio * 1.05

        cam = self.ren.GetActiveCamera()
        cam.SetParallelScale(scale)
        cam.SetFocalPoint(focal_pt_2d[0], focal_pt_2d[1], 0)
        cam.SetPosition(focal_pt_2d[0], focal_pt_2d[1], 100)
        cam.SetViewUp(0, 1, 0)
        cam.SetClippingRange(0, 200)
        self.iren.Render()

    def __on_load_wkt(self):
        self.geometry_label.setText("Geometry: nothing loaded")
        self.properties_label.setText("")
        file, _ = QtWidgets.QFileDialog.getOpenFileName(
            self, "Open WKT file", str(Path("~").expanduser())
        )
        try:
            wkt = jps.serialization.parse_wkt(
                Path(file).read_text(encoding="UTF-8")
            )
            self.navi = jpex.RoutingEngine(build_jps_geometry(wkt))
            xmin, ymin, xmax, ymax = wkt.bounds
            self.properties_label.setText(
                f"Dimensions: {math.ceil(xmax - xmin)}m x {math.ceil(ymax-ymin)}m "
                f"Triangles: {len(self.navi.mesh())}"
            )
            self.geometry_label.setText(f"Geometry: {file}")
        except Exception as e:
            QtWidgets.QMessageBox.critical(
                self,
                "Error importing WKT geometry",
                f"Error importing WKT geometry:\n{e}",
            )
            return

        self.move_controller.set_navi(self.navi)

        if self.geo:
            for actor in self.geo.get_actors():
                self.ren.RemoveActor(actor)
        self.geo = Geometry(self.navi)
        for actor in self.geo.get_actors():
            self.ren.AddActor(actor)

        self.hover_info.set_geo(self.geo)
        self.__reset_camera()
        self.iren.Render()


if __name__ == "__main__":
    app = QtWidgets.QApplication(sys.argv)
    window = MainWindow()
    sys.exit(app.exec())
